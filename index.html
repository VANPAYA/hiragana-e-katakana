<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kana Trainer</title>
  <style>
    :root{
      --bg0:#060812;
      --bg1:#0b1224;
      --card:rgba(255,255,255,.06);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.62);
      --ok:#22c55e;
      --bad:#ef4444;
      --accent:#38bdf8;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(56,189,248,.15), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(34,197,94,.12), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(239,68,68,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    .hidden{display:none}

    .topbar{
      position:fixed; inset:14px 14px auto 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .left, .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}

    select, button{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-weight:700;
      outline:none;
    }
    select{appearance:none; padding-right:34px}
    .selectWrap{position:relative}
    .selectWrap:after{
      content:"‚ñæ";
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      color:var(--muted);
      pointer-events:none;
      font-size:12px;
    }
    button{cursor:pointer}
    button:hover{background:rgba(255,255,255,.12)}
    button:active{transform:translateY(1px)}

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-weight:800;
      color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:999px; background:rgba(56,189,248,.85)}

    .center{
      height:100%;
      display:grid;
      place-items:center;
      padding:78px 14px 22px;
    }

    .stage{
      width:min(760px, 100%);
      background:var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:22px;
    }

    .prompt{
      display:flex;
      align-items:center;
      justify-content:center;
      height:210px;
      border-radius:var(--radius);
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      position:relative;
      overflow:hidden;
    }

    .kana{
      font-size:118px;
      line-height:1;
      font-weight:900;
      letter-spacing:.02em;
      text-shadow: 0 0 28px rgba(56,189,248,.16);
      user-select:none;
    }

    .sub{
      position:absolute;
      bottom:14px;
      color:var(--muted);
      font-weight:800;
      font-size:14px;
      opacity:0;
      transform:translateY(6px);
      transition: opacity .16s ease, transform .16s ease;
    }
    .sub.show{opacity:1; transform:translateY(0)}

    .controls{
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .input{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px 14px;
    }

    input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:18px;
      font-weight:900;
      letter-spacing:.02em;
    }

    .hint{
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      user-select:none;
    }

    .okBtn{
      padding:12px 14px;
      border-radius:14px;
      background:rgba(56,189,248,.22);
      border:1px solid rgba(56,189,248,.35);
      font-weight:900;
    }

    .flash{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity .12s ease;
    }
    .flash.ok{background:rgba(34,197,94,.14)}
    .flash.bad{background:rgba(239,68,68,.14)}
    .flash.on{opacity:1}

    .mini{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      opacity:.92;
      user-select:none;
    }

    .tinyBtn{
      padding:8px 10px;
      border-radius:12px;
      min-width:44px;
      display:grid;
      place-items:center;
    }

    .done{
      text-align:center;
      padding:34px 12px 12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.02em;
    }

    @media (max-width:520px){
      .kana{font-size:96px}
      .prompt{height:190px}
      .topbar{inset:12px 12px auto 12px}
      .stage{padding:16px}
      input{font-size:17px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <div class="selectWrap">
        <select id="setSelect" aria-label="Modo">
          <option value="both">Hira + Kata</option>
          <option value="hira">Hiragana</option>
          <option value="kata">Katakana</option>
        </select>
      </div>
      <button id="swapBtn" class="tinyBtn" title="Trocar dire√ß√£o">‚áÑ</button>
      <button id="audioBtn" class="tinyBtn" title="√Åudio">üîà</button>
    </div>
    <div class="right">
      <div class="pill" title="Prontos agora">
        <span class="dot"></span>
        <span id="due">0</span>
      </div>
      <button id="resetBtn" class="tinyBtn" title="Reset">‚Ü∫</button>
    </div>
  </div>

  <div class="center">
    <div class="stage">
      <div class="prompt" id="promptBox">
        <div class="kana" id="prompt">„ÅÇ</div>
        <div class="sub" id="reveal">a</div>
      </div>

      <div class="controls">
        <div class="input">
          <input id="answer" autocomplete="off" autocapitalize="off" spellcheck="false" placeholder="romaji" />
          <div class="hint">ENTER ‚Ä¢ SPACE</div>
        </div>
        <button id="okBtn" class="okBtn">OK</button>
      </div>

      <div class="mini">
        <span id="stat">‚Äî</span>
        <span id="mode">kana‚Üíromaji</span>
      </div>

      <div class="done hidden" id="done">feito por agora</div>
    </div>
  </div>

  <div class="flash ok" id="flashOk"></div>
  <div class="flash bad" id="flashBad"></div>

<script>
  // Imersivo + eficiente: Active Recall + SRS com passos curtos (tipo Anki) + persist√™ncia (localStorage)

  const HIRA = [
    ['„ÅÇ','a',[]],['„ÅÑ','i',[]],['„ÅÜ','u',[]],['„Åà','e',[]],['„Åä','o',[]],
    ['„Åã','ka',[]],['„Åç','ki',[]],['„Åè','ku',[]],['„Åë','ke',[]],['„Åì','ko',[]],
    ['„Åï','sa',[]],['„Åó','shi',['si']],['„Åô','su',[]],['„Åõ','se',[]],['„Åù','so',[]],
    ['„Åü','ta',[]],['„Å°','chi',['ti']],['„Å§','tsu',['tu']],['„Å¶','te',[]],['„Å®','to',[]],
    ['„Å™','na',[]],['„Å´','ni',[]],['„Å¨','nu',[]],['„Å≠','ne',[]],['„ÅÆ','no',[]],
    ['„ÅØ','ha',[]],['„Å≤','hi',[]],['„Åµ','fu',['hu']],['„Å∏','he',[]],['„Åª','ho',[]],
    ['„Åæ','ma',[]],['„Åø','mi',[]],['„ÇÄ','mu',[]],['„ÇÅ','me',[]],['„ÇÇ','mo',[]],
    ['„ÇÑ','ya',[]],['„ÇÜ','yu',[]],['„Çà','yo',[]],
    ['„Çâ','ra',[]],['„Çä','ri',[]],['„Çã','ru',[]],['„Çå','re',[]],['„Çç','ro',[]],
    ['„Çè','wa',[]],['„Çí','o',['wo']],['„Çì','n',['nn']],

    ['„Åå','ga',[]],['„Åé','gi',[]],['„Åê','gu',[]],['„Åí','ge',[]],['„Åî','go',[]],
    ['„Åñ','za',[]],['„Åò','ji',['zi']],['„Åö','zu',[]],['„Åú','ze',[]],['„Åû','zo',[]],
    ['„Å†','da',[]],['„Å¢','ji',['di','zi']],['„Å•','zu',['du']],['„Åß','de',[]],['„Å©','do',[]],
    ['„Å∞','ba',[]],['„Å≥','bi',[]],['„Å∂','bu',[]],['„Åπ','be',[]],['„Åº','bo',[]],
    ['„Å±','pa',[]],['„Å¥','pi',[]],['„Å∑','pu',[]],['„Å∫','pe',[]],['„ÅΩ','po',[]],

    ['„Åç„ÇÉ','kya',[]],['„Åç„ÇÖ','kyu',[]],['„Åç„Çá','kyo',[]],
    ['„Åó„ÇÉ','sha',['sya']],['„Åó„ÇÖ','shu',['syu']],['„Åó„Çá','sho',['syo']],
    ['„Å°„ÇÉ','cha',['tya']],['„Å°„ÇÖ','chu',['tyu']],['„Å°„Çá','cho',['tyo']],
    ['„Å´„ÇÉ','nya',[]],['„Å´„ÇÖ','nyu',[]],['„Å´„Çá','nyo',[]],
    ['„Å≤„ÇÉ','hya',[]],['„Å≤„ÇÖ','hyu',[]],['„Å≤„Çá','hyo',[]],
    ['„Åø„ÇÉ','mya',[]],['„Åø„ÇÖ','myu',[]],['„Åø„Çá','myo',[]],
    ['„Çä„ÇÉ','rya',[]],['„Çä„ÇÖ','ryu',[]],['„Çä„Çá','ryo',[]],
    ['„Åé„ÇÉ','gya',[]],['„Åé„ÇÖ','gyu',[]],['„Åé„Çá','gyo',[]],
    ['„Åò„ÇÉ','ja',['jya','zya']],['„Åò„ÇÖ','ju',['jyu','zyu']],['„Åò„Çá','jo',['jyo','zyo']],
    ['„Å≥„ÇÉ','bya',[]],['„Å≥„ÇÖ','byu',[]],['„Å≥„Çá','byo',[]],
    ['„Å¥„ÇÉ','pya',[]],['„Å¥„ÇÖ','pyu',[]],['„Å¥„Çá','pyo',[]],

    ['„Å£','(sokuon)',['xtsu','ltu']]
  ];

  const KATA = [
    ['„Ç¢','a',[]],['„Ç§','i',[]],['„Ç¶','u',[]],['„Ç®','e',[]],['„Ç™','o',[]],
    ['„Ç´','ka',[]],['„Ç≠','ki',[]],['„ÇØ','ku',[]],['„Ç±','ke',[]],['„Ç≥','ko',[]],
    ['„Çµ','sa',[]],['„Ç∑','shi',['si']],['„Çπ','su',[]],['„Çª','se',[]],['„ÇΩ','so',[]],
    ['„Çø','ta',[]],['„ÉÅ','chi',['ti']],['„ÉÑ','tsu',['tu']],['„ÉÜ','te',[]],['„Éà','to',[]],
    ['„Éä','na',[]],['„Éã','ni',[]],['„Éå','nu',[]],['„Éç','ne',[]],['„Éé','no',[]],
    ['„Éè','ha',[]],['„Éí','hi',[]],['„Éï','fu',['hu']],['„Éò','he',[]],['„Éõ','ho',[]],
    ['„Éû','ma',[]],['„Éü','mi',[]],['„É†','mu',[]],['„É°','me',[]],['„É¢','mo',[]],
    ['„É§','ya',[]],['„É¶','yu',[]],['„É®','yo',[]],
    ['„É©','ra',[]],['„É™','ri',[]],['„É´','ru',[]],['„É¨','re',[]],['„É≠','ro',[]],
    ['„ÉØ','wa',[]],['„É≤','o',['wo']],['„É≥','n',['nn']],

    ['„Ç¨','ga',[]],['„ÇÆ','gi',[]],['„Ç∞','gu',[]],['„Ç≤','ge',[]],['„Ç¥','go',[]],
    ['„Ç∂','za',[]],['„Ç∏','ji',['zi']],['„Ç∫','zu',[]],['„Çº','ze',[]],['„Çæ','zo',[]],
    ['„ÉÄ','da',[]],['„ÉÇ','ji',['di','zi']],['„ÉÖ','zu',['du']],['„Éá','de',[]],['„Éâ','do',[]],
    ['„Éê','ba',[]],['„Éì','bi',[]],['„Éñ','bu',[]],['„Éô','be',[]],['„Éú','bo',[]],
    ['„Éë','pa',[]],['„Éî','pi',[]],['„Éó','pu',[]],['„Éö','pe',[]],['„Éù','po',[]],

    ['„Ç≠„É£','kya',[]],['„Ç≠„É•','kyu',[]],['„Ç≠„Éß','kyo',[]],
    ['„Ç∑„É£','sha',['sya']],['„Ç∑„É•','shu',['syu']],['„Ç∑„Éß','sho',['syo']],
    ['„ÉÅ„É£','cha',['tya']],['„ÉÅ„É•','chu',['tyu']],['„ÉÅ„Éß','cho',['tyo']],
    ['„Éã„É£','nya',[]],['„Éã„É•','nyu',[]],['„Éã„Éß','nyo',[]],
    ['„Éí„É£','hya',[]],['„Éí„É•','hyu',[]],['„Éí„Éß','hyo',[]],
    ['„Éü„É£','mya',[]],['„Éü„É•','myu',[]],['„Éü„Éß','myo',[]],
    ['„É™„É£','rya',[]],['„É™„É•','ryu',[]],['„É™„Éß','ryo',[]],
    ['„ÇÆ„É£','gya',[]],['„ÇÆ„É•','gyu',[]],['„ÇÆ„Éß','gyo',[]],
    ['„Ç∏„É£','ja',['jya','zya']],['„Ç∏„É•','ju',['jyu','zyu']],['„Ç∏„Éß','jo',['jyo','zyo']],
    ['„Éì„É£','bya',[]],['„Éì„É•','byu',[]],['„Éì„Éß','byo',[]],
    ['„Éî„É£','pya',[]],['„Éî„É•','pyu',[]],['„Éî„Éß','pyo',[]],

    ['„ÉÉ','(sokuon)',['xtsu','ltu']]
  ];

  const KEY = 'kana_trainer_v3';
  const LEARN_STEPS_MIN = [0.15, 1, 6, 25];

  const elPrompt = document.getElementById('prompt');
  const elReveal = document.getElementById('reveal');
  const elAnswer = document.getElementById('answer');
  const elOk = document.getElementById('okBtn');
  const elDue = document.getElementById('due');
  const elStat = document.getElementById('stat');
  const elMode = document.getElementById('mode');
  const elSet = document.getElementById('setSelect');
  const elSwap = document.getElementById('swapBtn');
  const elAudio = document.getElementById('audioBtn');
  const elReset = document.getElementById('resetBtn');
  const elDone = document.getElementById('done');
  const flashOk = document.getElementById('flashOk');
  const flashBad = document.getElementById('flashBad');

  function now(){ return Date.now(); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  function makeDeck(list){
    return list.map(([k,r,alt]) => ({
      id:k, k, r, alt,
      ef:2.5, reps:0, intervalDays:0,
      phase:'new', step:0,
      due: now()
    }));
  }

  function loadState(){
    try{ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : null; }
    catch{ return null; }
  }
  function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  function normalize(s){
    s = (s || '').toLowerCase().trim();
    let out = '';
    for(let i=0;i<s.length;i++){
      const ch = s[i];
      if(ch===' ' || ch==='-' || ch==='	' || ch==='
' || ch==='
') continue;
      out += ch;
    }
    return out;
  }

  let state = loadState();
  if(!state){
    state = {
      set:'both',
      dir:'k2r',
      audio:false,
      deck:{ hira: makeDeck(HIRA), kata: makeDeck(KATA) },
      stats:{ reviews:0, correct:0, streak:0 }
    };
    saveState(state);
  }

  elSet.value = state.set;
  elMode.textContent = state.dir === 'k2r' ? 'kana‚Üíromaji' : 'romaji‚Üíkana';
  elAudio.textContent = state.audio ? 'üîä' : 'üîà';

  function pool(){
    if(state.set==='hira') return state.deck.hira;
    if(state.set==='kata') return state.deck.kata;
    return state.deck.hira.concat(state.deck.kata);
  }

  function dueCount(){
    const t = now();
    let c = 0;
    for(const x of pool()) if(x.due <= t) c++;
    return c;
  }

  function pickNext(){
    const t = now();
    const p = pool();
    const due = [];
    for(const x of p) if(x.due <= t) due.push(x);
    due.sort((a,b)=>a.due-b.due);

    if(due.length===0){
      const news = p.filter(x=>x.phase==='new');
      if(news.length===0) return null;
      return news[Math.floor(Math.random()*news.length)];
    }

    const head = due.slice(0,8);
    return head[Math.floor(Math.random()*head.length)];
  }

  let card = null;

  function speakKana(text){
    try{
      if(!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP';
      u.rate = 0.95;
      window.speechSynthesis.speak(u);
    }catch{}
  }

  function setPrompt(c){
    card = c;
    elReveal.classList.remove('show');

    if(state.dir==='k2r'){
      elPrompt.textContent = c.k;
      elReveal.textContent = c.r;
      elAnswer.placeholder = 'romaji';
    }else{
      elPrompt.textContent = c.r;
      elReveal.textContent = c.k;
      elAnswer.placeholder = 'kana (cole)';
    }

    elAnswer.value = '';
    elAnswer.focus();

    elDue.textContent = String(dueCount());

    const acc = state.stats.reviews ? Math.round((state.stats.correct/state.stats.reviews)*100) : 0;
    elStat.textContent = String(state.stats.streak) + ' streak ‚Ä¢ ' + String(acc) + '%';

    elDone.classList.add('hidden');

    if(state.audio && state.dir==='k2r') speakKana(c.k);
  }

  function showDone(){
    elDone.classList.remove('hidden');
    elPrompt.textContent = '‚Äî';
    elReveal.textContent = '';
    elAnswer.value = '';
    elDue.textContent = '0';
  }

  function acceptable(c){
    const base = [c.r].concat(c.alt || []).map(normalize);
    if(c.r==='(sokuon)') return ['(sokuon)','xtsu','ltu','„Å£','„ÉÉ'].map(normalize);
    return base;
  }

  function correct(input,c){
    const ans = normalize(input);
    if(!ans) return false;
    if(state.dir==='k2r') return acceptable(c).includes(ans);
    return normalize(c.k)===ans;
  }

  function flash(kind){
    const el = kind==='ok' ? flashOk : flashBad;
    el.classList.add('on');
    setTimeout(()=>el.classList.remove('on'), 110);
  }

  function schedule(c, ok){
    const t = now();
    state.stats.reviews++;

    if(ok){
      state.stats.correct++;
      state.stats.streak++;

      if(c.phase==='new' || c.phase==='learn'){
        c.phase='learn';
        c.step = (c.step||0) + 1;

        if(c.step >= LEARN_STEPS_MIN.length){
          c.phase='review';
          c.reps=1;
          c.intervalDays=1;
          c.ef = clamp(c.ef || 2.5, 1.3, 2.7);
          c.due = t + 86400000;
        }else{
          c.due = t + LEARN_STEPS_MIN[c.step]*60000;
        }
        return;
      }

      // SM-2 simplificado (qualidade 5)
      c.ef = clamp((c.ef||2.5) + 0.1, 1.3, 2.7);
      c.reps = (c.reps||0) + 1;
      if(c.reps===1) c.intervalDays=1;
      else if(c.reps===2) c.intervalDays=3;
      else c.intervalDays = Math.round((c.intervalDays||3) * c.ef);
      c.intervalDays = clamp(c.intervalDays, 1, 365);
      c.due = t + c.intervalDays*86400000;

    }else{
      state.stats.streak = 0;
      c.phase='learn';
      c.step=0;
      c.reps=0;
      c.intervalDays=0;
      c.ef = clamp((c.ef||2.5) - 0.2, 1.3, 2.7);
      c.due = t + LEARN_STEPS_MIN[0]*60000;
    }
  }

  function persistCard(c){
    const h = state.deck.hira.findIndex(x=>x.id===c.id);
    const k = state.deck.kata.findIndex(x=>x.id===c.id);
    if(h>=0) state.deck.hira[h]=c;
    if(k>=0) state.deck.kata[k]=c;
  }

  function next(){
    const n = pickNext();
    if(!n){ saveState(state); showDone(); return; }
    setPrompt(n);
    saveState(state);
  }

  function reveal(){ elReveal.classList.add('show'); }

  function submit(){
    if(!card) return;
    const ok = correct(elAnswer.value, card);
    reveal();
    flash(ok ? 'ok' : 'bad');
    schedule(card, ok);
    persistCard(card);
    saveState(state);
    setTimeout(next, ok ? 170 : 620);
  }

  elOk.addEventListener('click', submit);
  elAnswer.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); submit(); }
    if(e.key===' '){ e.preventDefault(); reveal(); if(state.audio && card && state.dir==='k2r') speakKana(card.k); }
  });

  elSet.addEventListener('change', ()=>{ state.set = elSet.value; saveState(state); next(); });
  elSwap.addEventListener('click', ()=>{ state.dir = state.dir==='k2r' ? 'r2k' : 'k2r'; elMode.textContent = state.dir==='k2r' ? 'kana‚Üíromaji' : 'romaji‚Üíkana'; saveState(state); next(); });
  elAudio.addEventListener('click', ()=>{ state.audio = !state.audio; elAudio.textContent = state.audio ? 'üîä' : 'üîà'; saveState(state); if(state.audio && card && state.dir==='k2r') speakKana(card.k); });
  elReset.addEventListener('click', ()=>{ state.deck={ hira: makeDeck(HIRA), kata: makeDeck(KATA) }; state.stats={ reviews:0, correct:0, streak:0 }; saveState(state); next(); });

  next();
</script>
</body>
</html>
